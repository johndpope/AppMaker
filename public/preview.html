<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App Maker - Application Preview</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.3.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/3.3.2/masonry.pkgd.min.js"></script>
    <script type="text/javascript" src="https://www.parsecdn.com/js/parse-1.2.7.min.js"></script>

    <style>
        body { padding-top: 70px; }
    </style>

    <script>
        function urldecode(str) {
            return decodeURIComponent((str + '').replace(/\+/g, '%20'));
        }
        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }


        var ws;
        var currentAppData;
        var publicPreviewKey;
        var device;
        var scale = 0.5;

        var deviceMap = {};
        deviceMap ["iphone4s"] = {width : "370", height : "733"};
        deviceMap ["iphone5s"] = {width:"365", height:"782"};
        deviceMap ["iphone6"] = {width:"416", height:"870"};
        deviceMap ["iphone6plus"] = {width:"690", height:"1420"};

        var buildServerURI = "ws://pbeast.asuscomm.com:9090";


        var showPreview = function(){
            var iFrameSrc = '<iframe src="https://appetize.io/embed/' + publicPreviewKey + '?device=' + device + '&scale='+ (scale * 100).toString() + '&autoplay=true&orientation=portrait&deviceColor=black" width="' + deviceMap[device].width * scale + 'px" height="' + deviceMap[device].height * scale + 'px" frameborder="0" scrolling="no"></iframe>'

            iFrame = $(iFrameSrc);
            $('#previewArea').empty();
            $('#previewArea').append(iFrame);
        }

        var buildForPreview = function(){

            $("#consoleLogModal").modal('show');
            $('#closeConsoleLog').attr("disabled", "disabled");
            $("#consoleLog").val("");

            ws = new WebSocket(buildServerURI);

            ws.onmessage = function (evt) {
                message = JSON.parse(evt.data)
                if (message.command == 'log') {
                    $("#consoleLog").val($("#consoleLog").val() + message.message);
                    $('#consoleLog').scrollTop($('#consoleLog')[0].scrollHeight);
                } else if (message.command == 'result') {
                    if (message.status == 'success') {
                        publicPreviewKey = message.data.publicKey;
                        currentAppData.set("previewPublicKey", publicPreviewKey);
                        currentAppData.save();

                        showPreview();

                        $('#consoleLogModal').modal('hide');
                    } else if (message.command == 'error') {
                        $("#consoleLog").val($("#consoleLog").val() + "\r" + message.message + " (" + message.exceptionMessage + ")");
                    }
                    else
                    {
                        $("#consoleLog").val($("#consoleLog").val() + "\r" + message.message + " (" + message.data.httpMessage + " : " + message.data.httpBody + ")");
                    }
                }
            };

            ws.onclose = function () {
                $("#consoleLog").val($("#consoleLog").val() + "\rConnection terminated\r");
                $('#closeConsoleLog').removeAttr("disabled");
            };
            ws.onopen = function () {
                $("#consoleLog").val("Connected to server" + "\r" + "\r");
                ws.send(JSON.stringify({command: "preparePreview", scheme: currentAppData.get("scheme")}));
            };
        };

        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();

            Parse.initialize("svGqYa9l2DYSLduyvo1ICgRwwHzhhSCEVUIGDnLi", "DUSNGLVKvwWOghh4Cta9VF8m3VHPU47jRZRBpSpk");

            var app_id = getUrlVars()["app_id"];
            var club_id = getUrlVars()["clubID"];
            device = getUrlVars()["device"];
            if (device == undefined || device == '')
                device = 'iphone5s'

            if (app_id == undefined) {
                window.history.back();
                return;
            }

            var query = new Parse.Query("Application");
            query.equalTo("apple_id", app_id);
            query.first({
                success: function (result) {
                    publicPreviewKey = result.get("previewPublicKey");
                    currentAppData = result;

                    if (publicPreviewKey == undefined || publicPreviewKey == ''){
                        buildForPreview();
                    }
                    else {
                        showPreview();
                    }
                },
                error: function (error) {
                    alert(error);
                }
            });

            $("#backToApp").on('click', function(event){
                event.preventDefault();

                window.location.href = "./appDetails.html?app_id="+currentAppData.get("apple_id");
            });

            $('.preview').on('click', function(event){
                event.preventDefault();

                device = $(this).attr('data');

                showPreview();
            });

            $('.scale').on('click', function(event){
                event.preventDefault();


                scale = parseFloat($(this).attr('data'));

                showPreview();
            });
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#" id="backToApp">Back To Application Details</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false">Scale <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" class="scale" data="0.25">25%</a></li>
                            <li><a href="#" class="scale" data="0.5">50%</a></li>
                            <li><a href="#" class="scale" data="0.75">75%</a></li>
                            <li><a href="#" class="scale" data="1">100%</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false">Device <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" class="preview" data="iphone4s">iPhone 4s</a></li>
                            <li><a href="#" class="preview" data="iphone5s">iPhone 5s</a></li>
                            <li><a href="#" class="preview" data="iphone6">iPhone 6</a></li>
                            <li><a href="#" class="preview" data="iphone6plus">iPhone 6 Plus</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div id="previewArea">

        </div>
    </div>
    <!-- Console -->
    <div class="modal fade" id="consoleLogModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">Console</h4>
                </div>
                <div class="modal-body">
                    <textarea style='background-color: black; color: lightgreen;font-family: monaco,Consolas,"Lucida Console",monospace'  class="form-control" id="consoleLog" rows="15" readonly>

                    </textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" disabled="disabled" id="closeConsoleLog">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>